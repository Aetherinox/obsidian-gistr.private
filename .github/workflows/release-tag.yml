# ---------------------------------------------------------------------------------------
#   @parent     : github workflow
#   @desc       : push release (tag)
#   @author     : Aetherinox
#   @url        : https://github.com/Aetherinox
# ---------------------------------------------------------------------------------------

name: "Publish Release [Tag]"
run-name: "Release [Tag] - ${{ github.event.workflow_run.id }}"

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: "Release Candidate"
        required: true
        default: false
        type: boolean
      rc_version:
        description: "RC Version"
        required: false
        type: string
        default: 1
env:
    PLUGIN_NAME: gistr
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
          contents: write
        steps:
            - uses: actions/checkout@v2
            - name: Use Node.js
              uses: actions/setup-node@v1
              with:
                  node-version: "20.x"

            # ---------------------------------------------------------------------------------------
            #   Get version from package.json VERSION value
            # ---------------------------------------------------------------------------------------

            - name: Get Package Version
              id: get_package_version
              run: echo "PACKAGE_VERSION=$(cat package.json | jq -r '.version')" >> $GITHUB_ENV

            # ---------------------------------------------------------------------------------------
            #   Build ( Release Candidate )
            # ---------------------------------------------------------------------------------------

            - name: Build (Release Candidate)
              id: dev
              if: ${{ startsWith( inputs.prerelease, true ) }}
              run: |
                  echo Building PRE-RELEASE Package .zip PACKAGE_VERSION
                  npm ci
                  npm run build
                  zip -jr ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}-rc.${{ inputs.rc_version }}.zip dist/*
                  ls

            # ---------------------------------------------------------------------------------------
            #   Build ( Stable )
            # ---------------------------------------------------------------------------------------

            - name: Build (Stable)
              id: build
              if: ${{ startsWith( inputs.prerelease, false ) }}
              run: |
                  echo Building STABLE Package .zip PACKAGE_VERSION
                  npm ci
                  npm run build
                  zip -jr ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}.zip dist/*
                  ls

            # ---------------------------------------------------------------------------------------
            #   Checksum ( Release Candidate )
            # ---------------------------------------------------------------------------------------

            - name: Create checksum (Release Candidate)
              if: ${{ startsWith( inputs.prerelease, true ) }}
              run: |
                shasum --algorithm 256 ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}-rc.${{ inputs.rc_version }}.zip > SHA256SUMS.txt

            # ---------------------------------------------------------------------------------------
            #   Checksum ( Release )
            # ---------------------------------------------------------------------------------------

            - name: Create checksum (Release)
              if: ${{ startsWith( inputs.prerelease, false ) }}
              run: |
                shasum --algorithm 256 ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}.zip > SHA256SUMS.txt

            - name: Generate Changelog
              id: changelog
              uses: jaywcjlove/changelog-generator@v1.5.3
              with:
                filter: (^[\s]+?[R|r]elease)|(^[R|r]elease)

            - name: Get the changelog
              run: echo "${{ steps.changelog.outputs.changelog }}"

            # ---------------------------------------------------------------------------------------
            #   [ Release Candidate ]: Create Release
            # ---------------------------------------------------------------------------------------

            - name: Release Candidate
              if: ${{ startsWith( inputs.prerelease, true ) }}
              uses: softprops/action-gh-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                name: v${{ env.PACKAGE_VERSION }}-rc.${{ inputs.rc_version }}
                tag_name: ${{ env.PACKAGE_VERSION }}
                target_commitish: ${{ github.event.inputs.branch }}
                draft: false
                generate_release_notes: true
                files: |
                  ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}-rc.${{ inputs.rc_version }}.zip
                  dist/main.js
                  dist/manifest.json
                  dist/styles.css
                  SHA256SUMS.txt
                prerelease: true
                body: |
                  # Database Migrations
                  TODO
                  ${{ steps.changelog.outputs.changelog }}

            # ---------------------------------------------------------------------------------------
            #   [ Release ]: Create Release
            # ---------------------------------------------------------------------------------------

            - name: Release
              if: ${{ startsWith( inputs.prerelease, false ) }}
              uses: softprops/action-gh-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                name: v${{ env.PACKAGE_VERSION }}
                tag_name: ${{ env.PACKAGE_VERSION }}
                target_commitish: ${{ github.event.inputs.branch }}
                draft: false
                generate_release_notes: true
                files: |
                  ${{ env.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}.zip
                  dist/main.js
                  dist/manifest.json
                  dist/styles.css
                  checksum.txt
                prerelease: false